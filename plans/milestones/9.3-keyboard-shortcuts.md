# Milestone 9.3: Keyboard Shortcuts

> **Phase:** 9 - User Experience
> **Status:** NOT STARTED
> **Priority:** LOW
> **Complexity:** Low
> **Estimated Time:** 2-3 hours

---

## Prompt for Claude Code

```
You are working on the Email Validator project. Your task is to implement keyboard shortcuts.

IMPORTANT INSTRUCTIONS:
1. Read this entire file before starting
2. Follow the implementation steps in order
3. Write comprehensive tests
4. Update the checklist as you complete each task
5. Commit with message: "feat: add keyboard shortcuts for quick navigation"
6. Push the changes

PROJECT CONTEXT:
- This is a Next.js 14 application
- Use React hooks for keyboard handling
- Show help modal with ? key
- Consider accessibility
```

---

## Objective

Implement keyboard shortcuts for power users:
- Quick navigation between pages
- Focus email input
- Submit validation
- Clear input
- Show help modal
- Accessible to screen readers

---

## Implementation Steps

### Step 1: Create Keyboard Shortcuts Hook

Create `src/hooks/useKeyboardShortcuts.ts`:

```typescript
import { useEffect, useCallback } from 'react';

export interface KeyboardShortcut {
  key: string;
  ctrl?: boolean;
  alt?: boolean;
  shift?: boolean;
  meta?: boolean;
  action: () => void;
  description: string;
  category: string;
}

export function useKeyboardShortcuts(
  shortcuts: KeyboardShortcut[],
  enabled: boolean = true
) {
  const handleKeyDown = useCallback(
    (event: KeyboardEvent) => {
      if (!enabled) return;

      // Don't trigger shortcuts when typing in inputs (except specific ones)
      const target = event.target as HTMLElement;
      const isInput = ['INPUT', 'TEXTAREA', 'SELECT'].includes(target.tagName);
      const isContentEditable = target.isContentEditable;

      for (const shortcut of shortcuts) {
        const keyMatch = event.key.toLowerCase() === shortcut.key.toLowerCase();
        const ctrlMatch = !!shortcut.ctrl === (event.ctrlKey || event.metaKey);
        const altMatch = !!shortcut.alt === event.altKey;
        const shiftMatch = !!shortcut.shift === event.shiftKey;

        if (keyMatch && ctrlMatch && altMatch && shiftMatch) {
          // Allow certain shortcuts even in inputs
          const allowInInput = shortcut.ctrl || shortcut.alt;

          if (isInput && !isContentEditable && !allowInInput) {
            continue;
          }

          event.preventDefault();
          shortcut.action();
          return;
        }
      }
    },
    [shortcuts, enabled]
  );

  useEffect(() => {
    if (enabled) {
      window.addEventListener('keydown', handleKeyDown);
      return () => window.removeEventListener('keydown', handleKeyDown);
    }
  }, [handleKeyDown, enabled]);
}

/**
 * Format shortcut key for display
 */
export function formatShortcutKey(shortcut: KeyboardShortcut): string {
  const parts: string[] = [];

  if (shortcut.ctrl) {
    parts.push(navigator.platform.includes('Mac') ? '⌘' : 'Ctrl');
  }
  if (shortcut.alt) {
    parts.push(navigator.platform.includes('Mac') ? '⌥' : 'Alt');
  }
  if (shortcut.shift) {
    parts.push('⇧');
  }

  // Format special keys
  const keyMap: Record<string, string> = {
    ' ': 'Space',
    escape: 'Esc',
    enter: '↵',
    arrowup: '↑',
    arrowdown: '↓',
    arrowleft: '←',
    arrowright: '→',
  };

  const displayKey = keyMap[shortcut.key.toLowerCase()] || shortcut.key.toUpperCase();
  parts.push(displayKey);

  return parts.join(' + ');
}
```

### Step 2: Create Shortcuts Context

Create `src/contexts/ShortcutsContext.tsx`:

```typescript
'use client';

import {
  createContext,
  useContext,
  useState,
  useCallback,
  ReactNode,
} from 'react';
import { KeyboardShortcut } from '@/hooks/useKeyboardShortcuts';

interface ShortcutsContextType {
  shortcuts: KeyboardShortcut[];
  registerShortcuts: (shortcuts: KeyboardShortcut[]) => void;
  unregisterShortcuts: (keys: string[]) => void;
  isHelpOpen: boolean;
  openHelp: () => void;
  closeHelp: () => void;
  enabled: boolean;
  setEnabled: (enabled: boolean) => void;
}

const ShortcutsContext = createContext<ShortcutsContextType | null>(null);

export function ShortcutsProvider({ children }: { children: ReactNode }) {
  const [shortcuts, setShortcuts] = useState<KeyboardShortcut[]>([]);
  const [isHelpOpen, setIsHelpOpen] = useState(false);
  const [enabled, setEnabled] = useState(true);

  const registerShortcuts = useCallback((newShortcuts: KeyboardShortcut[]) => {
    setShortcuts((prev) => {
      const keys = newShortcuts.map((s) => s.key);
      const filtered = prev.filter((s) => !keys.includes(s.key));
      return [...filtered, ...newShortcuts];
    });
  }, []);

  const unregisterShortcuts = useCallback((keys: string[]) => {
    setShortcuts((prev) => prev.filter((s) => !keys.includes(s.key)));
  }, []);

  const openHelp = useCallback(() => setIsHelpOpen(true), []);
  const closeHelp = useCallback(() => setIsHelpOpen(false), []);

  return (
    <ShortcutsContext.Provider
      value={{
        shortcuts,
        registerShortcuts,
        unregisterShortcuts,
        isHelpOpen,
        openHelp,
        closeHelp,
        enabled,
        setEnabled,
      }}
    >
      {children}
    </ShortcutsContext.Provider>
  );
}

export function useShortcuts() {
  const context = useContext(ShortcutsContext);
  if (!context) {
    throw new Error('useShortcuts must be used within a ShortcutsProvider');
  }
  return context;
}
```

### Step 3: Create Shortcuts Help Modal

Create `src/components/shortcuts/ShortcutsHelp.tsx`:

```typescript
'use client';

import { useEffect } from 'react';
import { useShortcuts } from '@/contexts/ShortcutsContext';
import { formatShortcutKey } from '@/hooks/useKeyboardShortcuts';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import { Badge } from '@/components/ui/badge';
import { Keyboard } from 'lucide-react';

export function ShortcutsHelp() {
  const { shortcuts, isHelpOpen, closeHelp } = useShortcuts();

  // Group shortcuts by category
  const groupedShortcuts = shortcuts.reduce(
    (acc, shortcut) => {
      if (!acc[shortcut.category]) {
        acc[shortcut.category] = [];
      }
      acc[shortcut.category].push(shortcut);
      return acc;
    },
    {} as Record<string, typeof shortcuts>
  );

  return (
    <Dialog open={isHelpOpen} onOpenChange={closeHelp}>
      <DialogContent className="max-w-lg">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <Keyboard className="h-5 w-5" />
            Keyboard Shortcuts
          </DialogTitle>
        </DialogHeader>

        <div className="space-y-6">
          {Object.entries(groupedShortcuts).map(([category, categoryShortcuts]) => (
            <div key={category}>
              <h3 className="text-sm font-medium text-muted-foreground mb-2">
                {category}
              </h3>
              <div className="space-y-2">
                {categoryShortcuts.map((shortcut) => (
                  <div
                    key={shortcut.key}
                    className="flex items-center justify-between"
                  >
                    <span className="text-sm">{shortcut.description}</span>
                    <Badge variant="outline" className="font-mono">
                      {formatShortcutKey(shortcut)}
                    </Badge>
                  </div>
                ))}
              </div>
            </div>
          ))}
        </div>

        <p className="text-xs text-muted-foreground mt-4">
          Press <Badge variant="outline" className="font-mono text-xs">?</Badge> to
          show this help anytime
        </p>
      </DialogContent>
    </Dialog>
  );
}
```

### Step 4: Create Global Shortcuts Provider

Create `src/components/shortcuts/GlobalShortcuts.tsx`:

```typescript
'use client';

import { useEffect } from 'react';
import { useRouter, usePathname } from 'next/navigation';
import { useShortcuts } from '@/contexts/ShortcutsContext';
import { useKeyboardShortcuts, KeyboardShortcut } from '@/hooks/useKeyboardShortcuts';
import { ShortcutsHelp } from './ShortcutsHelp';

export function GlobalShortcuts() {
  const router = useRouter();
  const pathname = usePathname();
  const { registerShortcuts, openHelp, enabled } = useShortcuts();

  useEffect(() => {
    const globalShortcuts: KeyboardShortcut[] = [
      // Help
      {
        key: '?',
        shift: true,
        action: openHelp,
        description: 'Show keyboard shortcuts',
        category: 'General',
      },
      // Navigation
      {
        key: 'g',
        action: () => {},
        description: 'Go to... (press again for destination)',
        category: 'Navigation',
      },
      {
        key: 'h',
        ctrl: true,
        action: () => router.push('/'),
        description: 'Go to Home',
        category: 'Navigation',
      },
      {
        key: 'b',
        ctrl: true,
        action: () => router.push('/bulk'),
        description: 'Go to Bulk Validation',
        category: 'Navigation',
      },
      {
        key: 'i',
        ctrl: true,
        action: () => router.push('/history'),
        description: 'Go to History',
        category: 'Navigation',
      },
      {
        key: 'd',
        ctrl: true,
        action: () => router.push('/api-docs'),
        description: 'Go to API Docs',
        category: 'Navigation',
      },
      // Actions
      {
        key: '/',
        action: () => {
          const input = document.querySelector<HTMLInputElement>(
            'input[type="email"], input[name="email"], input[placeholder*="email"]'
          );
          input?.focus();
        },
        description: 'Focus email input',
        category: 'Actions',
      },
      {
        key: 'Escape',
        action: () => {
          const activeElement = document.activeElement as HTMLElement;
          activeElement?.blur();
        },
        description: 'Unfocus / Close modal',
        category: 'Actions',
      },
    ];

    registerShortcuts(globalShortcuts);
  }, [registerShortcuts, router, openHelp]);

  const { shortcuts } = useShortcuts();
  useKeyboardShortcuts(shortcuts, enabled);

  return <ShortcutsHelp />;
}
```

### Step 5: Create Page-Specific Shortcuts

Create `src/components/shortcuts/HomeShortcuts.tsx`:

```typescript
'use client';

import { useEffect } from 'react';
import { useShortcuts } from '@/contexts/ShortcutsContext';
import { KeyboardShortcut } from '@/hooks/useKeyboardShortcuts';

interface HomeShortcutsProps {
  onValidate: () => void;
  onClear: () => void;
}

export function HomeShortcuts({ onValidate, onClear }: HomeShortcutsProps) {
  const { registerShortcuts, unregisterShortcuts } = useShortcuts();

  useEffect(() => {
    const shortcuts: KeyboardShortcut[] = [
      {
        key: 'Enter',
        ctrl: true,
        action: onValidate,
        description: 'Validate email',
        category: 'Home Page',
      },
      {
        key: 'k',
        ctrl: true,
        action: onClear,
        description: 'Clear input',
        category: 'Home Page',
      },
    ];

    registerShortcuts(shortcuts);

    return () => {
      unregisterShortcuts(shortcuts.map((s) => s.key));
    };
  }, [registerShortcuts, unregisterShortcuts, onValidate, onClear]);

  return null;
}
```

Create `src/components/shortcuts/BulkShortcuts.tsx`:

```typescript
'use client';

import { useEffect } from 'react';
import { useShortcuts } from '@/contexts/ShortcutsContext';
import { KeyboardShortcut } from '@/hooks/useKeyboardShortcuts';

interface BulkShortcutsProps {
  onValidateAll: () => void;
  onExport: () => void;
  onClear: () => void;
}

export function BulkShortcuts({ onValidateAll, onExport, onClear }: BulkShortcutsProps) {
  const { registerShortcuts, unregisterShortcuts } = useShortcuts();

  useEffect(() => {
    const shortcuts: KeyboardShortcut[] = [
      {
        key: 'Enter',
        ctrl: true,
        action: onValidateAll,
        description: 'Validate all emails',
        category: 'Bulk Page',
      },
      {
        key: 'e',
        ctrl: true,
        action: onExport,
        description: 'Export results',
        category: 'Bulk Page',
      },
      {
        key: 'k',
        ctrl: true,
        action: onClear,
        description: 'Clear all',
        category: 'Bulk Page',
      },
    ];

    registerShortcuts(shortcuts);

    return () => {
      unregisterShortcuts(shortcuts.map((s) => s.key));
    };
  }, [registerShortcuts, unregisterShortcuts, onValidateAll, onExport, onClear]);

  return null;
}
```

### Step 6: Create Shortcut Indicator

Create `src/components/shortcuts/ShortcutIndicator.tsx`:

```typescript
'use client';

import { Badge } from '@/components/ui/badge';

interface ShortcutIndicatorProps {
  shortcut: string;
  className?: string;
}

export function ShortcutIndicator({ shortcut, className }: ShortcutIndicatorProps) {
  return (
    <Badge
      variant="outline"
      className={`text-xs font-mono opacity-60 ${className}`}
    >
      {shortcut}
    </Badge>
  );
}
```

### Step 7: Update Layout with Provider

Update `src/app/layout.tsx`:

```typescript
import { ShortcutsProvider } from '@/contexts/ShortcutsContext';
import { GlobalShortcuts } from '@/components/shortcuts/GlobalShortcuts';

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <body>
        <ShortcutsProvider>
          <GlobalShortcuts />
          {children}
        </ShortcutsProvider>
      </body>
    </html>
  );
}
```

### Step 8: Update Components with Shortcuts

Update `src/components/email/EmailValidator.tsx`:

```typescript
import { HomeShortcuts } from '@/components/shortcuts/HomeShortcuts';
import { ShortcutIndicator } from '@/components/shortcuts/ShortcutIndicator';

export function EmailValidator() {
  // ... existing code

  return (
    <div>
      <HomeShortcuts
        onValidate={handleValidate}
        onClear={handleClear}
      />

      <Input
        placeholder="Enter email address (Press / to focus)"
        // ...
      />

      <Button>
        Validate
        <ShortcutIndicator shortcut="⌘↵" className="ml-2" />
      </Button>
    </div>
  );
}
```

### Step 9: Write Tests

Create `src/__tests__/hooks/useKeyboardShortcuts.test.ts`:

```typescript
import { renderHook, act } from '@testing-library/react';
import { useKeyboardShortcuts, formatShortcutKey, KeyboardShortcut } from '@/hooks/useKeyboardShortcuts';

describe('useKeyboardShortcuts', () => {
  test('calls action on matching key press', () => {
    const action = jest.fn();
    const shortcuts: KeyboardShortcut[] = [
      {
        key: 'a',
        action,
        description: 'Test action',
        category: 'Test',
      },
    ];

    renderHook(() => useKeyboardShortcuts(shortcuts));

    act(() => {
      const event = new KeyboardEvent('keydown', { key: 'a' });
      window.dispatchEvent(event);
    });

    expect(action).toHaveBeenCalled();
  });

  test('handles ctrl modifier', () => {
    const action = jest.fn();
    const shortcuts: KeyboardShortcut[] = [
      {
        key: 'k',
        ctrl: true,
        action,
        description: 'Test action',
        category: 'Test',
      },
    ];

    renderHook(() => useKeyboardShortcuts(shortcuts));

    // Without ctrl - should not trigger
    act(() => {
      const event = new KeyboardEvent('keydown', { key: 'k' });
      window.dispatchEvent(event);
    });
    expect(action).not.toHaveBeenCalled();

    // With ctrl - should trigger
    act(() => {
      const event = new KeyboardEvent('keydown', { key: 'k', ctrlKey: true });
      window.dispatchEvent(event);
    });
    expect(action).toHaveBeenCalled();
  });

  test('does not trigger when disabled', () => {
    const action = jest.fn();
    const shortcuts: KeyboardShortcut[] = [
      {
        key: 'a',
        action,
        description: 'Test action',
        category: 'Test',
      },
    ];

    renderHook(() => useKeyboardShortcuts(shortcuts, false));

    act(() => {
      const event = new KeyboardEvent('keydown', { key: 'a' });
      window.dispatchEvent(event);
    });

    expect(action).not.toHaveBeenCalled();
  });
});

describe('formatShortcutKey', () => {
  test('formats simple key', () => {
    const shortcut: KeyboardShortcut = {
      key: 'a',
      action: () => {},
      description: 'Test',
      category: 'Test',
    };

    expect(formatShortcutKey(shortcut)).toBe('A');
  });

  test('formats with modifiers', () => {
    const shortcut: KeyboardShortcut = {
      key: 'k',
      ctrl: true,
      shift: true,
      action: () => {},
      description: 'Test',
      category: 'Test',
    };

    const result = formatShortcutKey(shortcut);
    expect(result).toContain('K');
    expect(result).toContain('⇧');
  });

  test('formats special keys', () => {
    const shortcut: KeyboardShortcut = {
      key: 'enter',
      action: () => {},
      description: 'Test',
      category: 'Test',
    };

    expect(formatShortcutKey(shortcut)).toBe('↵');
  });
});
```

---

## Completion Checklist

```
[ ] useKeyboardShortcuts hook created
[ ] ShortcutsContext created
[ ] ShortcutsProvider component
[ ] ShortcutsHelp modal component
[ ] GlobalShortcuts component
[ ] Page-specific shortcuts (Home, Bulk)
[ ] ShortcutIndicator component
[ ] Layout updated with provider
[ ] Navigation shortcuts (Ctrl+H, etc.)
[ ] Focus shortcut (/)
[ ] Help shortcut (?)
[ ] Validate shortcut (Ctrl+Enter)
[ ] Clear shortcut (Ctrl+K)
[ ] Export shortcut (Ctrl+E)
[ ] Accessibility considered
[ ] Tests written and passing
[ ] All existing tests pass
[ ] Changes committed and pushed
```

---

## Keyboard Shortcuts Reference

| Shortcut | Action | Page |
|----------|--------|------|
| `?` | Show help modal | Global |
| `/` | Focus email input | Global |
| `Esc` | Unfocus / Close modal | Global |
| `Ctrl+H` | Go to Home | Global |
| `Ctrl+B` | Go to Bulk | Global |
| `Ctrl+I` | Go to History | Global |
| `Ctrl+D` | Go to API Docs | Global |
| `Ctrl+Enter` | Validate email | Home/Bulk |
| `Ctrl+K` | Clear input | Home/Bulk |
| `Ctrl+E` | Export results | Bulk |

---

## Next Milestone

After completing this milestone, proceed to:
`plans/milestones/9.4-list-cleaning.md`
