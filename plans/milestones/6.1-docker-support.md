# Milestone 6.1: Docker Support

> **Phase:** 6 - DevOps & Deployment
> **Status:** NOT STARTED
> **Priority:** HIGH
> **Complexity:** Low
> **Estimated Time:** 2-3 hours

---

## Prompt for Claude Code

```
You are working on the Email Validator project. Your task is to implement Docker support.

IMPORTANT INSTRUCTIONS:
1. Read this entire file before starting
2. Follow the implementation steps in order
3. Write tests for all new functionality
4. Update the checklist as you complete each task
5. Commit after completing the milestone with message: "feat: add Docker support for containerized deployment"
6. Push the changes

PROJECT CONTEXT:
- This is a Next.js 14 application with App Router
- Uses TypeScript, Tailwind CSS, shadcn/ui
- Has Jest for unit tests and Playwright for E2E
- API routes at /api/validate, /api/validate-bulk, /api/health

CURRENT FILE STRUCTURE:
D:\Email Validator\
├── src/
│   ├── app/
│   ├── components/
│   ├── lib/
│   └── types/
├── public/
├── e2e/
├── package.json
├── next.config.js
└── tsconfig.json
```

---

## Objective

Create Docker configuration for easy deployment and development, including:
- Production-optimized Dockerfile with multi-stage build
- docker-compose.yml for local development
- Health checks and proper signal handling
- Documentation for Docker usage

---

## Implementation Steps

### Step 1: Create Dockerfile

Create `Dockerfile` in project root:

```dockerfile
# ============================================
# Stage 1: Dependencies
# ============================================
FROM node:20-alpine AS deps
RUN apk add --no-cache libc6-compat
WORKDIR /app

# Copy package files
COPY package.json package-lock.json ./

# Install dependencies
RUN npm ci --only=production

# ============================================
# Stage 2: Builder
# ============================================
FROM node:20-alpine AS builder
WORKDIR /app

# Copy dependencies from deps stage
COPY --from=deps /app/node_modules ./node_modules
COPY . .

# Set environment variables for build
ENV NEXT_TELEMETRY_DISABLED=1
ENV NODE_ENV=production

# Build the application
RUN npm run build

# ============================================
# Stage 3: Runner (Production)
# ============================================
FROM node:20-alpine AS runner
WORKDIR /app

# Set environment
ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1

# Create non-root user for security
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

# Copy built application
COPY --from=builder /app/public ./public
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static

# Set correct permissions
RUN chown -R nextjs:nodejs /app

# Switch to non-root user
USER nextjs

# Expose port
EXPOSE 3000

# Set port environment variable
ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1

# Start the application
CMD ["node", "server.js"]
```

### Step 2: Update next.config.js for Standalone Output

Update `next.config.js`:

```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  output: 'standalone',

  // ... existing config ...

  // Ensure proper handling in Docker
  experimental: {
    // Enable if needed
  },
};

module.exports = nextConfig;
```

### Step 3: Create docker-compose.yml

Create `docker-compose.yml`:

```yaml
version: '3.8'

services:
  email-validator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: email-validator
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - API_KEY_REQUIRED=false
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # Development service with hot reload
  email-validator-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: email-validator-dev
    ports:
      - "3000:3000"
    volumes:
      - .:/app
      - /app/node_modules
      - /app/.next
    environment:
      - NODE_ENV=development
      - WATCHPACK_POLLING=true
    profiles:
      - dev
```

### Step 4: Create Dockerfile.dev for Development

Create `Dockerfile.dev`:

```dockerfile
FROM node:20-alpine

WORKDIR /app

# Install dependencies for native modules
RUN apk add --no-cache libc6-compat

# Copy package files
COPY package.json package-lock.json ./

# Install all dependencies (including dev)
RUN npm ci

# Copy source code
COPY . .

# Expose port
EXPOSE 3000

# Start development server
CMD ["npm", "run", "dev"]
```

### Step 5: Create .dockerignore

Create `.dockerignore`:

```
# Dependencies
node_modules
.pnp
.pnp.js

# Testing
coverage
.nyc_output
e2e/test-results
playwright-report
screenshots

# Build outputs
.next
out
build
dist

# Development
.env*.local
.env.development
.env.test

# IDE
.idea
.vscode
*.swp
*.swo

# OS
.DS_Store
Thumbs.db

# Git
.git
.gitignore

# Docker
Dockerfile*
docker-compose*
.docker

# Documentation
*.md
!README.md

# Tests
**/*.test.ts
**/*.test.tsx
**/*.spec.ts
jest.config.js
playwright.config.ts

# Misc
.eslintcache
.turbo
npm-debug.log*
yarn-error.log*
```

### Step 6: Add npm Scripts

Update `package.json` scripts:

```json
{
  "scripts": {
    "docker:build": "docker build -t email-validator .",
    "docker:run": "docker run -p 3000:3000 email-validator",
    "docker:dev": "docker-compose --profile dev up email-validator-dev",
    "docker:prod": "docker-compose up -d email-validator",
    "docker:stop": "docker-compose down",
    "docker:logs": "docker-compose logs -f",
    "docker:clean": "docker system prune -f && docker volume prune -f"
  }
}
```

### Step 7: Create Docker Documentation

Create `docs/DOCKER.md`:

```markdown
# Docker Deployment Guide

## Quick Start

### Production Build & Run

```bash
# Build the image
npm run docker:build

# Run the container
npm run docker:run

# Or use docker-compose
npm run docker:prod
```

### Development with Hot Reload

```bash
npm run docker:dev
```

## Configuration

### Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `NODE_ENV` | Environment mode | `production` |
| `PORT` | Server port | `3000` |
| `API_KEY_REQUIRED` | Require API key | `false` |
| `API_KEYS` | Comma-separated API keys | - |
| `ALLOWED_ORIGINS` | CORS allowed origins | `*` |

### Health Check

The container includes a health check that pings `/api/health` every 30 seconds.

```bash
# Check container health
docker inspect --format='{{.State.Health.Status}}' email-validator
```

## Docker Commands

```bash
# Build image
docker build -t email-validator .

# Run container
docker run -p 3000:3000 -e API_KEY_REQUIRED=true email-validator

# Run with custom port
docker run -p 8080:3000 email-validator

# View logs
docker logs -f email-validator

# Stop container
docker stop email-validator

# Remove container
docker rm email-validator
```

## Docker Compose

```bash
# Start services
docker-compose up -d

# Stop services
docker-compose down

# View logs
docker-compose logs -f

# Rebuild
docker-compose up -d --build
```

## Image Size Optimization

The multi-stage build produces an optimized image:

- Stage 1: Install dependencies (~500MB)
- Stage 2: Build application
- Stage 3: Production runner (~150MB final)

## Security

- Runs as non-root user (`nextjs`)
- Only production dependencies included
- No source code in production image
- Health checks enabled

## Troubleshooting

### Container won't start

```bash
# Check logs
docker logs email-validator

# Check health
docker inspect email-validator | grep -A 10 Health
```

### Port already in use

```bash
# Use different port
docker run -p 8080:3000 email-validator
```
```

### Step 8: Write Tests

Create `src/__tests__/docker/docker.test.ts`:

```typescript
/**
 * Docker configuration tests
 * These tests verify Docker-related files exist and are properly configured
 */

import fs from 'fs';
import path from 'path';

describe('Docker Configuration', () => {
  const rootDir = process.cwd();

  describe('Dockerfile', () => {
    const dockerfilePath = path.join(rootDir, 'Dockerfile');

    test('Dockerfile exists', () => {
      expect(fs.existsSync(dockerfilePath)).toBe(true);
    });

    test('Dockerfile has multi-stage build', () => {
      const content = fs.readFileSync(dockerfilePath, 'utf-8');
      expect(content).toContain('FROM node:20-alpine AS deps');
      expect(content).toContain('FROM node:20-alpine AS builder');
      expect(content).toContain('FROM node:20-alpine AS runner');
    });

    test('Dockerfile runs as non-root user', () => {
      const content = fs.readFileSync(dockerfilePath, 'utf-8');
      expect(content).toContain('USER nextjs');
    });

    test('Dockerfile has health check', () => {
      const content = fs.readFileSync(dockerfilePath, 'utf-8');
      expect(content).toContain('HEALTHCHECK');
    });
  });

  describe('docker-compose.yml', () => {
    const composePath = path.join(rootDir, 'docker-compose.yml');

    test('docker-compose.yml exists', () => {
      expect(fs.existsSync(composePath)).toBe(true);
    });

    test('docker-compose.yml has production service', () => {
      const content = fs.readFileSync(composePath, 'utf-8');
      expect(content).toContain('email-validator:');
    });
  });

  describe('.dockerignore', () => {
    const dockerignorePath = path.join(rootDir, '.dockerignore');

    test('.dockerignore exists', () => {
      expect(fs.existsSync(dockerignorePath)).toBe(true);
    });

    test('.dockerignore excludes node_modules', () => {
      const content = fs.readFileSync(dockerignorePath, 'utf-8');
      expect(content).toContain('node_modules');
    });

    test('.dockerignore excludes .next', () => {
      const content = fs.readFileSync(dockerignorePath, 'utf-8');
      expect(content).toContain('.next');
    });
  });

  describe('next.config.js', () => {
    const configPath = path.join(rootDir, 'next.config.js');

    test('next.config.js has standalone output', () => {
      const content = fs.readFileSync(configPath, 'utf-8');
      expect(content).toContain("output: 'standalone'");
    });
  });
});
```

---

## Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `Dockerfile` | CREATE | Multi-stage production build |
| `Dockerfile.dev` | CREATE | Development with hot reload |
| `docker-compose.yml` | CREATE | Container orchestration |
| `.dockerignore` | CREATE | Build context exclusions |
| `next.config.js` | MODIFY | Add standalone output |
| `package.json` | MODIFY | Add docker scripts |
| `docs/DOCKER.md` | CREATE | Docker documentation |
| `src/__tests__/docker/docker.test.ts` | CREATE | Configuration tests |

---

## Verification Steps

After implementation, verify:

1. **Build works:**
   ```bash
   npm run docker:build
   ```

2. **Container runs:**
   ```bash
   npm run docker:run
   # Visit http://localhost:3000
   ```

3. **Health check works:**
   ```bash
   curl http://localhost:3000/api/health
   ```

4. **Tests pass:**
   ```bash
   npm test -- --testPathPattern=docker
   ```

---

## Completion Checklist

```
[ ] Dockerfile created with multi-stage build
[ ] Dockerfile.dev created for development
[ ] docker-compose.yml created
[ ] .dockerignore configured
[ ] next.config.js updated with standalone output
[ ] package.json scripts added
[ ] docs/DOCKER.md documentation created
[ ] Tests written and passing
[ ] Container builds successfully
[ ] Container runs and serves application
[ ] Health check endpoint works
[ ] All existing tests still pass
[ ] Changes committed and pushed
```

---

## Notes

- The standalone output mode reduces the Docker image size significantly
- Using Alpine Linux for smaller base image
- Non-root user for security best practices
- Health checks ensure container reliability in orchestration systems

---

## Next Milestone

After completing this milestone, proceed to:
`plans/milestones/6.2-cli-tool.md`
