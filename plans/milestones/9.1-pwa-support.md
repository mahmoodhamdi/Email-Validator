# Milestone 9.1: PWA Support

> **Phase:** 9 - User Experience
> **Status:** NOT STARTED
> **Priority:** MEDIUM
> **Complexity:** Medium
> **Estimated Time:** 4-5 hours

---

## Prompt for Claude Code

```
You are working on the Email Validator project. Your task is to implement PWA (Progressive Web App) support.

IMPORTANT INSTRUCTIONS:
1. Read this entire file before starting
2. Follow the implementation steps in order
3. Write comprehensive tests
4. Update the checklist as you complete each task
5. Commit with message: "feat: add PWA support with offline functionality"
6. Push the changes

PROJECT CONTEXT:
- This is a Next.js 14 application
- Uses App Router
- Existing pages: /, /bulk, /history, /api-docs
```

---

## Objective

Implement PWA support to enable:
- Installable app experience
- Offline functionality
- App-like navigation
- Push notifications (optional)
- Better mobile experience

---

## Implementation Steps

### Step 1: Install Dependencies

```bash
npm install next-pwa
npm install -D @types/workbox-window
```

### Step 2: Create Web Manifest

Create `public/manifest.json`:

```json
{
  "name": "Email Validator",
  "short_name": "EmailVal",
  "description": "Validate email addresses with comprehensive checks",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#2563eb",
  "orientation": "portrait-primary",
  "icons": [
    {
      "src": "/icons/icon-72x72.png",
      "sizes": "72x72",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "/icons/icon-96x96.png",
      "sizes": "96x96",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "/icons/icon-128x128.png",
      "sizes": "128x128",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "/icons/icon-144x144.png",
      "sizes": "144x144",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "/icons/icon-152x152.png",
      "sizes": "152x152",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "/icons/icon-192x192.png",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "/icons/icon-384x384.png",
      "sizes": "384x384",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "/icons/icon-512x512.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "any maskable"
    }
  ],
  "screenshots": [
    {
      "src": "/screenshots/desktop.png",
      "sizes": "1920x1080",
      "type": "image/png",
      "form_factor": "wide"
    },
    {
      "src": "/screenshots/mobile.png",
      "sizes": "390x844",
      "type": "image/png",
      "form_factor": "narrow"
    }
  ],
  "shortcuts": [
    {
      "name": "Validate Email",
      "short_name": "Validate",
      "description": "Validate a single email",
      "url": "/",
      "icons": [{ "src": "/icons/icon-96x96.png", "sizes": "96x96" }]
    },
    {
      "name": "Bulk Validation",
      "short_name": "Bulk",
      "description": "Validate multiple emails",
      "url": "/bulk",
      "icons": [{ "src": "/icons/icon-96x96.png", "sizes": "96x96" }]
    },
    {
      "name": "History",
      "short_name": "History",
      "description": "View validation history",
      "url": "/history",
      "icons": [{ "src": "/icons/icon-96x96.png", "sizes": "96x96" }]
    }
  ],
  "categories": ["utilities", "productivity"],
  "lang": "en",
  "dir": "ltr"
}
```

### Step 3: Update Next.js Config

Update `next.config.js`:

```javascript
const withPWA = require('next-pwa')({
  dest: 'public',
  register: true,
  skipWaiting: true,
  disable: process.env.NODE_ENV === 'development',
  runtimeCaching: [
    {
      urlPattern: /^https:\/\/fonts\.(?:googleapis|gstatic)\.com\/.*/i,
      handler: 'CacheFirst',
      options: {
        cacheName: 'google-fonts',
        expiration: {
          maxEntries: 4,
          maxAgeSeconds: 365 * 24 * 60 * 60, // 1 year
        },
      },
    },
    {
      urlPattern: /\.(?:eot|otf|ttc|ttf|woff|woff2|font.css)$/i,
      handler: 'StaleWhileRevalidate',
      options: {
        cacheName: 'static-font-assets',
        expiration: {
          maxEntries: 4,
          maxAgeSeconds: 7 * 24 * 60 * 60, // 1 week
        },
      },
    },
    {
      urlPattern: /\.(?:jpg|jpeg|gif|png|svg|ico|webp)$/i,
      handler: 'StaleWhileRevalidate',
      options: {
        cacheName: 'static-image-assets',
        expiration: {
          maxEntries: 64,
          maxAgeSeconds: 24 * 60 * 60, // 24 hours
        },
      },
    },
    {
      urlPattern: /\.(?:js)$/i,
      handler: 'StaleWhileRevalidate',
      options: {
        cacheName: 'static-js-assets',
        expiration: {
          maxEntries: 32,
          maxAgeSeconds: 24 * 60 * 60, // 24 hours
        },
      },
    },
    {
      urlPattern: /\.(?:css|less)$/i,
      handler: 'StaleWhileRevalidate',
      options: {
        cacheName: 'static-style-assets',
        expiration: {
          maxEntries: 32,
          maxAgeSeconds: 24 * 60 * 60, // 24 hours
        },
      },
    },
    {
      urlPattern: /^https:\/\/api\.*/i,
      handler: 'NetworkFirst',
      options: {
        cacheName: 'api-cache',
        networkTimeoutSeconds: 10,
        expiration: {
          maxEntries: 16,
          maxAgeSeconds: 24 * 60 * 60, // 24 hours
        },
        cacheableResponse: {
          statuses: [0, 200],
        },
      },
    },
    {
      urlPattern: /\/api\/validate/i,
      handler: 'NetworkOnly',
    },
    {
      urlPattern: /.*/i,
      handler: 'NetworkFirst',
      options: {
        cacheName: 'others',
        networkTimeoutSeconds: 10,
        expiration: {
          maxEntries: 32,
          maxAgeSeconds: 24 * 60 * 60, // 24 hours
        },
        cacheableResponse: {
          statuses: [0, 200],
        },
      },
    },
  ],
});

/** @type {import('next').NextConfig} */
const nextConfig = {
  output: 'standalone',
  // ... existing config
};

module.exports = withPWA(nextConfig);
```

### Step 4: Update Root Layout

Update `src/app/layout.tsx`:

```typescript
import { Metadata, Viewport } from 'next';

export const viewport: Viewport = {
  themeColor: [
    { media: '(prefers-color-scheme: light)', color: '#ffffff' },
    { media: '(prefers-color-scheme: dark)', color: '#0a0a0a' },
  ],
  width: 'device-width',
  initialScale: 1,
  maximumScale: 5,
  userScalable: true,
};

export const metadata: Metadata = {
  title: 'Email Validator',
  description: 'Validate email addresses with comprehensive checks',
  manifest: '/manifest.json',
  appleWebApp: {
    capable: true,
    statusBarStyle: 'default',
    title: 'Email Validator',
  },
  formatDetection: {
    telephone: false,
  },
  openGraph: {
    type: 'website',
    siteName: 'Email Validator',
    title: 'Email Validator',
    description: 'Validate email addresses with comprehensive checks',
  },
  twitter: {
    card: 'summary',
    title: 'Email Validator',
    description: 'Validate email addresses with comprehensive checks',
  },
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <head>
        <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-192x192.png" />
        <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32x32.png" />
        <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-16x16.png" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="default" />
      </head>
      <body>
        {children}
      </body>
    </html>
  );
}
```

### Step 5: Create Install Prompt Component

Create `src/components/pwa/InstallPrompt.tsx`:

```typescript
'use client';

import { useState, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Card, CardContent } from '@/components/ui/card';
import { Download, X } from 'lucide-react';

interface BeforeInstallPromptEvent extends Event {
  prompt: () => Promise<void>;
  userChoice: Promise<{ outcome: 'accepted' | 'dismissed' }>;
}

export function InstallPrompt() {
  const [deferredPrompt, setDeferredPrompt] = useState<BeforeInstallPromptEvent | null>(null);
  const [showPrompt, setShowPrompt] = useState(false);
  const [isInstalled, setIsInstalled] = useState(false);

  useEffect(() => {
    // Check if already installed
    if (window.matchMedia('(display-mode: standalone)').matches) {
      setIsInstalled(true);
      return;
    }

    // Check localStorage for dismissed prompt
    const dismissed = localStorage.getItem('pwa-install-dismissed');
    if (dismissed) {
      const dismissedTime = parseInt(dismissed, 10);
      // Show again after 7 days
      if (Date.now() - dismissedTime < 7 * 24 * 60 * 60 * 1000) {
        return;
      }
    }

    const handler = (e: Event) => {
      e.preventDefault();
      setDeferredPrompt(e as BeforeInstallPromptEvent);
      setShowPrompt(true);
    };

    window.addEventListener('beforeinstallprompt', handler);

    // Handle successful install
    window.addEventListener('appinstalled', () => {
      setIsInstalled(true);
      setShowPrompt(false);
      setDeferredPrompt(null);
    });

    return () => {
      window.removeEventListener('beforeinstallprompt', handler);
    };
  }, []);

  const handleInstall = async () => {
    if (!deferredPrompt) return;

    await deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;

    if (outcome === 'accepted') {
      setShowPrompt(false);
    }

    setDeferredPrompt(null);
  };

  const handleDismiss = () => {
    setShowPrompt(false);
    localStorage.setItem('pwa-install-dismissed', Date.now().toString());
  };

  if (isInstalled || !showPrompt) return null;

  return (
    <div className="fixed bottom-4 left-4 right-4 z-50 md:left-auto md:right-4 md:w-96">
      <Card className="shadow-lg">
        <CardContent className="p-4">
          <div className="flex items-start gap-3">
            <div className="flex-shrink-0 p-2 bg-primary/10 rounded-lg">
              <Download className="h-6 w-6 text-primary" />
            </div>
            <div className="flex-1">
              <h3 className="font-semibold">Install Email Validator</h3>
              <p className="text-sm text-muted-foreground mt-1">
                Install our app for quick access and offline support
              </p>
              <div className="flex gap-2 mt-3">
                <Button size="sm" onClick={handleInstall}>
                  Install
                </Button>
                <Button size="sm" variant="ghost" onClick={handleDismiss}>
                  Not now
                </Button>
              </div>
            </div>
            <Button
              size="icon"
              variant="ghost"
              className="h-6 w-6"
              onClick={handleDismiss}
            >
              <X className="h-4 w-4" />
            </Button>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
```

### Step 6: Create Offline Indicator

Create `src/components/pwa/OfflineIndicator.tsx`:

```typescript
'use client';

import { useState, useEffect } from 'react';
import { WifiOff } from 'lucide-react';

export function OfflineIndicator() {
  const [isOffline, setIsOffline] = useState(false);

  useEffect(() => {
    setIsOffline(!navigator.onLine);

    const handleOnline = () => setIsOffline(false);
    const handleOffline = () => setIsOffline(true);

    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);

    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, []);

  if (!isOffline) return null;

  return (
    <div className="fixed top-0 left-0 right-0 bg-yellow-500 text-yellow-900 py-2 px-4 text-center text-sm z-50 flex items-center justify-center gap-2">
      <WifiOff className="h-4 w-4" />
      <span>You are offline. Some features may be unavailable.</span>
    </div>
  );
}
```

### Step 7: Create Update Available Component

Create `src/components/pwa/UpdateAvailable.tsx`:

```typescript
'use client';

import { useState, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Card, CardContent } from '@/components/ui/card';
import { RefreshCw } from 'lucide-react';

export function UpdateAvailable() {
  const [showUpdate, setShowUpdate] = useState(false);
  const [registration, setRegistration] = useState<ServiceWorkerRegistration | null>(null);

  useEffect(() => {
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.ready.then((reg) => {
        setRegistration(reg);

        reg.addEventListener('updatefound', () => {
          const newWorker = reg.installing;
          if (newWorker) {
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                setShowUpdate(true);
              }
            });
          }
        });
      });

      // Check for updates every hour
      const interval = setInterval(() => {
        navigator.serviceWorker.ready.then((reg) => {
          reg.update();
        });
      }, 60 * 60 * 1000);

      return () => clearInterval(interval);
    }
  }, []);

  const handleUpdate = () => {
    if (registration?.waiting) {
      registration.waiting.postMessage({ type: 'SKIP_WAITING' });
    }
    window.location.reload();
  };

  if (!showUpdate) return null;

  return (
    <div className="fixed bottom-4 right-4 z-50">
      <Card className="shadow-lg">
        <CardContent className="p-4">
          <div className="flex items-center gap-3">
            <RefreshCw className="h-5 w-5 text-primary" />
            <div>
              <p className="font-medium">Update Available</p>
              <p className="text-sm text-muted-foreground">
                A new version is ready
              </p>
            </div>
            <Button size="sm" onClick={handleUpdate}>
              Update
            </Button>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
```

### Step 8: Create PWA Provider

Create `src/components/pwa/PWAProvider.tsx`:

```typescript
'use client';

import { InstallPrompt } from './InstallPrompt';
import { OfflineIndicator } from './OfflineIndicator';
import { UpdateAvailable } from './UpdateAvailable';

export function PWAProvider({ children }: { children: React.ReactNode }) {
  return (
    <>
      <OfflineIndicator />
      {children}
      <InstallPrompt />
      <UpdateAvailable />
    </>
  );
}
```

### Step 9: Create Offline Page

Create `src/app/offline/page.tsx`:

```typescript
import { WifiOff, RefreshCw } from 'lucide-react';
import { Button } from '@/components/ui/button';

export default function OfflinePage() {
  return (
    <div className="flex flex-col items-center justify-center min-h-screen p-4 text-center">
      <WifiOff className="h-16 w-16 text-muted-foreground mb-4" />
      <h1 className="text-2xl font-bold mb-2">You're Offline</h1>
      <p className="text-muted-foreground mb-6 max-w-md">
        It looks like you've lost your internet connection. Some features won't be
        available until you're back online.
      </p>
      <Button onClick={() => window.location.reload()}>
        <RefreshCw className="h-4 w-4 mr-2" />
        Try Again
      </Button>
    </div>
  );
}
```

### Step 10: Generate Icons

Create a script to generate icons `scripts/generate-icons.js`:

```javascript
const sharp = require('sharp');
const fs = require('fs');
const path = require('path');

const sizes = [16, 32, 72, 96, 128, 144, 152, 192, 384, 512];
const inputIcon = path.join(__dirname, '../public/logo.svg');
const outputDir = path.join(__dirname, '../public/icons');

// Ensure output directory exists
if (!fs.existsSync(outputDir)) {
  fs.mkdirSync(outputDir, { recursive: true });
}

async function generateIcons() {
  for (const size of sizes) {
    await sharp(inputIcon)
      .resize(size, size)
      .png()
      .toFile(path.join(outputDir, `icon-${size}x${size}.png`));

    console.log(`Generated icon-${size}x${size}.png`);
  }
}

generateIcons().catch(console.error);
```

### Step 11: Write Tests

Create `src/__tests__/components/pwa/pwa.test.tsx`:

```typescript
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { InstallPrompt } from '@/components/pwa/InstallPrompt';
import { OfflineIndicator } from '@/components/pwa/OfflineIndicator';

describe('PWA Components', () => {
  describe('InstallPrompt', () => {
    beforeEach(() => {
      localStorage.clear();
    });

    test('does not render when already installed', () => {
      // Mock standalone mode
      Object.defineProperty(window, 'matchMedia', {
        value: jest.fn().mockImplementation((query) => ({
          matches: query === '(display-mode: standalone)',
          addListener: jest.fn(),
          removeListener: jest.fn(),
        })),
      });

      render(<InstallPrompt />);

      expect(screen.queryByText('Install Email Validator')).not.toBeInTheDocument();
    });

    test('handles dismiss correctly', async () => {
      Object.defineProperty(window, 'matchMedia', {
        value: jest.fn().mockImplementation(() => ({
          matches: false,
          addListener: jest.fn(),
          removeListener: jest.fn(),
        })),
      });

      // Trigger beforeinstallprompt
      const promptEvent = new Event('beforeinstallprompt');
      (promptEvent as any).preventDefault = jest.fn();
      (promptEvent as any).prompt = jest.fn();
      (promptEvent as any).userChoice = Promise.resolve({ outcome: 'dismissed' });

      render(<InstallPrompt />);

      window.dispatchEvent(promptEvent);

      await waitFor(() => {
        expect(screen.queryByText('Install Email Validator')).toBeInTheDocument();
      });

      fireEvent.click(screen.getByText('Not now'));

      expect(screen.queryByText('Install Email Validator')).not.toBeInTheDocument();
      expect(localStorage.getItem('pwa-install-dismissed')).toBeTruthy();
    });
  });

  describe('OfflineIndicator', () => {
    test('shows indicator when offline', () => {
      Object.defineProperty(navigator, 'onLine', {
        value: false,
        writable: true,
      });

      render(<OfflineIndicator />);

      expect(screen.getByText(/You are offline/)).toBeInTheDocument();
    });

    test('hides indicator when online', () => {
      Object.defineProperty(navigator, 'onLine', {
        value: true,
        writable: true,
      });

      render(<OfflineIndicator />);

      expect(screen.queryByText(/You are offline/)).not.toBeInTheDocument();
    });

    test('responds to online/offline events', async () => {
      Object.defineProperty(navigator, 'onLine', {
        value: true,
        writable: true,
      });

      render(<OfflineIndicator />);

      expect(screen.queryByText(/You are offline/)).not.toBeInTheDocument();

      // Simulate going offline
      window.dispatchEvent(new Event('offline'));

      await waitFor(() => {
        expect(screen.getByText(/You are offline/)).toBeInTheDocument();
      });

      // Simulate going online
      window.dispatchEvent(new Event('online'));

      await waitFor(() => {
        expect(screen.queryByText(/You are offline/)).not.toBeInTheDocument();
      });
    });
  });
});
```

---

## Completion Checklist

```
[ ] next-pwa installed and configured
[ ] manifest.json created
[ ] App icons generated
[ ] next.config.js updated with PWA config
[ ] Root layout updated with metadata
[ ] InstallPrompt component created
[ ] OfflineIndicator component created
[ ] UpdateAvailable component created
[ ] PWAProvider created
[ ] Offline page created
[ ] Service worker caching configured
[ ] Tests written and passing
[ ] Build succeeds with PWA
[ ] App installable on mobile/desktop
[ ] Offline mode works
[ ] Changes committed and pushed
```

---

## Next Milestone

After completing this milestone, proceed to:
`plans/milestones/9.2-internationalization.md`
