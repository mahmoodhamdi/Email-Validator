# Milestone 9.5: Google Contacts Import

> **Phase:** 9 - User Experience
> **Status:** NOT STARTED
> **Priority:** MEDIUM
> **Complexity:** High
> **Estimated Time:** 5-6 hours

---

## Prompt for Claude Code

```
You are working on the Email Validator project. Your task is to implement Google Contacts import.

IMPORTANT INSTRUCTIONS:
1. Read this entire file before starting
2. Follow the implementation steps in order
3. Write comprehensive tests
4. Update the checklist as you complete each task
5. Commit with message: "feat: add Google Contacts import functionality"
6. Push the changes

PROJECT CONTEXT:
- This is a Next.js 14 application
- Use Google OAuth 2.0 for authentication
- Use People API for contacts access
- Handle privacy and security carefully
```

---

## Objective

Implement Google Contacts import functionality:
- Google OAuth 2.0 authentication
- Fetch contacts via People API
- Contact selection UI
- Batch import to validator
- Error handling and privacy

---

## Implementation Steps

### Step 1: Install Dependencies

```bash
npm install @googleapis/people
npm install next-auth @auth/core
```

### Step 2: Create Google OAuth Configuration

Create `.env.local` variables (document in README):

```env
GOOGLE_CLIENT_ID=your-client-id
GOOGLE_CLIENT_SECRET=your-client-secret
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=your-nextauth-secret
```

### Step 3: Create NextAuth Configuration

Create `src/app/api/auth/[...nextauth]/route.ts`:

```typescript
import NextAuth from 'next-auth';
import GoogleProvider from 'next-auth/providers/google';

const handler = NextAuth({
  providers: [
    GoogleProvider({
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
      authorization: {
        params: {
          scope: 'openid email profile https://www.googleapis.com/auth/contacts.readonly',
          prompt: 'consent',
          access_type: 'offline',
          response_type: 'code',
        },
      },
    }),
  ],
  callbacks: {
    async jwt({ token, account }) {
      if (account) {
        token.accessToken = account.access_token;
        token.refreshToken = account.refresh_token;
        token.expiresAt = account.expires_at;
      }
      return token;
    },
    async session({ session, token }) {
      session.accessToken = token.accessToken as string;
      return session;
    },
  },
  pages: {
    signIn: '/import/google',
    error: '/import/google/error',
  },
});

export { handler as GET, handler as POST };
```

Create `src/types/next-auth.d.ts`:

```typescript
import 'next-auth';

declare module 'next-auth' {
  interface Session {
    accessToken?: string;
  }
}

declare module 'next-auth/jwt' {
  interface JWT {
    accessToken?: string;
    refreshToken?: string;
    expiresAt?: number;
  }
}
```

### Step 4: Create Google Contacts Types

Create `src/lib/google/types.ts`:

```typescript
export interface GoogleContact {
  resourceName: string;
  etag: string;
  names?: {
    displayName?: string;
    familyName?: string;
    givenName?: string;
  }[];
  emailAddresses?: {
    value: string;
    type?: string;
    formattedType?: string;
  }[];
  photos?: {
    url: string;
    default?: boolean;
  }[];
  organizations?: {
    name?: string;
    title?: string;
  }[];
}

export interface ContactsResponse {
  connections?: GoogleContact[];
  totalPeople?: number;
  totalItems?: number;
  nextPageToken?: string;
}

export interface ParsedContact {
  id: string;
  name: string;
  email: string;
  photo?: string;
  organization?: string;
  type?: string;
}

export interface ImportSelection {
  contacts: ParsedContact[];
  selectedIds: Set<string>;
}
```

### Step 5: Create Google Contacts Service

Create `src/lib/google/contacts.ts`:

```typescript
import { GoogleContact, ContactsResponse, ParsedContact } from './types';

const PEOPLE_API_BASE = 'https://people.googleapis.com/v1';

/**
 * Fetch contacts from Google People API
 */
export async function fetchGoogleContacts(
  accessToken: string,
  pageToken?: string
): Promise<{
  contacts: ParsedContact[];
  nextPageToken?: string;
  totalItems: number;
}> {
  const params = new URLSearchParams({
    personFields: 'names,emailAddresses,photos,organizations',
    pageSize: '100',
  });

  if (pageToken) {
    params.set('pageToken', pageToken);
  }

  const response = await fetch(
    `${PEOPLE_API_BASE}/people/me/connections?${params}`,
    {
      headers: {
        Authorization: `Bearer ${accessToken}`,
      },
    }
  );

  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error?.message || 'Failed to fetch contacts');
  }

  const data: ContactsResponse = await response.json();
  const contacts = parseContacts(data.connections || []);

  return {
    contacts,
    nextPageToken: data.nextPageToken,
    totalItems: data.totalItems || 0,
  };
}

/**
 * Fetch all contacts (handles pagination)
 */
export async function fetchAllGoogleContacts(
  accessToken: string,
  onProgress?: (loaded: number, total: number) => void
): Promise<ParsedContact[]> {
  const allContacts: ParsedContact[] = [];
  let pageToken: string | undefined;
  let totalItems = 0;

  do {
    const result = await fetchGoogleContacts(accessToken, pageToken);

    allContacts.push(...result.contacts);
    pageToken = result.nextPageToken;
    totalItems = result.totalItems || allContacts.length;

    onProgress?.(allContacts.length, totalItems);
  } while (pageToken);

  return allContacts;
}

/**
 * Parse raw Google contacts to simplified format
 */
function parseContacts(contacts: GoogleContact[]): ParsedContact[] {
  const parsed: ParsedContact[] = [];

  for (const contact of contacts) {
    const emails = contact.emailAddresses || [];

    for (const email of emails) {
      if (!email.value) continue;

      parsed.push({
        id: `${contact.resourceName}_${email.value}`,
        name: contact.names?.[0]?.displayName || email.value.split('@')[0],
        email: email.value.toLowerCase(),
        photo: contact.photos?.find((p) => !p.default)?.url,
        organization: contact.organizations?.[0]?.name,
        type: email.formattedType,
      });
    }
  }

  return parsed;
}

/**
 * Filter contacts that have email addresses
 */
export function filterContactsWithEmail(contacts: ParsedContact[]): ParsedContact[] {
  return contacts.filter((c) => c.email && c.email.includes('@'));
}

/**
 * Group contacts by domain
 */
export function groupContactsByDomain(
  contacts: ParsedContact[]
): Map<string, ParsedContact[]> {
  const groups = new Map<string, ParsedContact[]>();

  for (const contact of contacts) {
    const domain = contact.email.split('@')[1] || 'unknown';

    if (!groups.has(domain)) {
      groups.set(domain, []);
    }
    groups.get(domain)!.push(contact);
  }

  return groups;
}
```

### Step 6: Create Contacts API Route

Create `src/app/api/google/contacts/route.ts`:

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { getServerSession } from 'next-auth';
import { fetchAllGoogleContacts } from '@/lib/google/contacts';

export async function GET(request: NextRequest) {
  try {
    const session = await getServerSession();

    if (!session?.accessToken) {
      return NextResponse.json(
        { error: 'Not authenticated' },
        { status: 401 }
      );
    }

    const contacts = await fetchAllGoogleContacts(session.accessToken);

    return NextResponse.json({
      success: true,
      contacts,
      count: contacts.length,
    });
  } catch (error) {
    console.error('Error fetching contacts:', error);
    return NextResponse.json(
      { error: error instanceof Error ? error.message : 'Failed to fetch contacts' },
      { status: 500 }
    );
  }
}
```

### Step 7: Create Import UI Components

Create `src/components/google/GoogleSignIn.tsx`:

```typescript
'use client';

import { signIn, signOut, useSession } from 'next-auth/react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Chrome, LogOut, Shield } from 'lucide-react';

export function GoogleSignIn() {
  const { data: session, status } = useSession();

  if (status === 'loading') {
    return (
      <Card>
        <CardContent className="p-6 text-center">
          <div className="animate-pulse">Loading...</div>
        </CardContent>
      </Card>
    );
  }

  if (session) {
    return (
      <Card>
        <CardContent className="p-6">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              {session.user?.image && (
                <img
                  src={session.user.image}
                  alt=""
                  className="w-10 h-10 rounded-full"
                />
              )}
              <div>
                <p className="font-medium">{session.user?.name}</p>
                <p className="text-sm text-muted-foreground">{session.user?.email}</p>
              </div>
            </div>
            <Button variant="outline" onClick={() => signOut()}>
              <LogOut className="h-4 w-4 mr-2" />
              Sign Out
            </Button>
          </div>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <Chrome className="h-5 w-5" />
          Connect Google Account
        </CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        <p className="text-muted-foreground">
          Sign in with Google to import your contacts for validation.
        </p>

        <div className="flex items-start gap-2 p-3 bg-muted rounded-lg text-sm">
          <Shield className="h-4 w-4 mt-0.5 text-green-600" />
          <div>
            <p className="font-medium">Your privacy is protected</p>
            <p className="text-muted-foreground">
              We only request read-only access to your contacts. Your data is
              never stored on our servers.
            </p>
          </div>
        </div>

        <Button onClick={() => signIn('google')} className="w-full">
          <Chrome className="h-4 w-4 mr-2" />
          Sign in with Google
        </Button>
      </CardContent>
    </Card>
  );
}
```

Create `src/components/google/ContactSelector.tsx`:

```typescript
'use client';

import { useState, useMemo } from 'react';
import { ParsedContact } from '@/lib/google/types';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Checkbox } from '@/components/ui/checkbox';
import { Badge } from '@/components/ui/badge';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Search, User, Building, CheckSquare, Square } from 'lucide-react';

interface ContactSelectorProps {
  contacts: ParsedContact[];
  onImport: (emails: string[]) => void;
  isImporting?: boolean;
}

export function ContactSelector({
  contacts,
  onImport,
  isImporting,
}: ContactSelectorProps) {
  const [search, setSearch] = useState('');
  const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());

  const filteredContacts = useMemo(() => {
    if (!search) return contacts;

    const searchLower = search.toLowerCase();
    return contacts.filter(
      (c) =>
        c.name.toLowerCase().includes(searchLower) ||
        c.email.toLowerCase().includes(searchLower) ||
        c.organization?.toLowerCase().includes(searchLower)
    );
  }, [contacts, search]);

  const toggleContact = (id: string) => {
    setSelectedIds((prev) => {
      const next = new Set(prev);
      if (next.has(id)) {
        next.delete(id);
      } else {
        next.add(id);
      }
      return next;
    });
  };

  const toggleAll = () => {
    if (selectedIds.size === filteredContacts.length) {
      setSelectedIds(new Set());
    } else {
      setSelectedIds(new Set(filteredContacts.map((c) => c.id)));
    }
  };

  const handleImport = () => {
    const selectedEmails = contacts
      .filter((c) => selectedIds.has(c.id))
      .map((c) => c.email);
    onImport(selectedEmails);
  };

  return (
    <div className="space-y-4">
      {/* Search and Actions */}
      <div className="flex gap-2">
        <div className="relative flex-1">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
          <Input
            placeholder="Search contacts..."
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            className="pl-9"
          />
        </div>
        <Button variant="outline" onClick={toggleAll}>
          {selectedIds.size === filteredContacts.length ? (
            <Square className="h-4 w-4 mr-2" />
          ) : (
            <CheckSquare className="h-4 w-4 mr-2" />
          )}
          {selectedIds.size === filteredContacts.length ? 'Deselect All' : 'Select All'}
        </Button>
      </div>

      {/* Stats */}
      <div className="flex gap-2 text-sm">
        <Badge variant="outline">{contacts.length} contacts</Badge>
        <Badge variant="secondary">{selectedIds.size} selected</Badge>
        {search && (
          <Badge variant="outline">{filteredContacts.length} matching</Badge>
        )}
      </div>

      {/* Contact List */}
      <ScrollArea className="h-[400px] border rounded-lg">
        <div className="p-2 space-y-1">
          {filteredContacts.map((contact) => (
            <div
              key={contact.id}
              className={`flex items-center gap-3 p-2 rounded-lg cursor-pointer hover:bg-muted ${
                selectedIds.has(contact.id) ? 'bg-muted' : ''
              }`}
              onClick={() => toggleContact(contact.id)}
            >
              <Checkbox
                checked={selectedIds.has(contact.id)}
                onCheckedChange={() => toggleContact(contact.id)}
              />

              {contact.photo ? (
                <img
                  src={contact.photo}
                  alt=""
                  className="w-10 h-10 rounded-full"
                />
              ) : (
                <div className="w-10 h-10 rounded-full bg-muted flex items-center justify-center">
                  <User className="h-5 w-5 text-muted-foreground" />
                </div>
              )}

              <div className="flex-1 min-w-0">
                <p className="font-medium truncate">{contact.name}</p>
                <p className="text-sm text-muted-foreground truncate">
                  {contact.email}
                </p>
              </div>

              {contact.organization && (
                <div className="flex items-center gap-1 text-sm text-muted-foreground">
                  <Building className="h-3 w-3" />
                  <span className="truncate max-w-[100px]">
                    {contact.organization}
                  </span>
                </div>
              )}

              {contact.type && (
                <Badge variant="outline" className="text-xs">
                  {contact.type}
                </Badge>
              )}
            </div>
          ))}

          {filteredContacts.length === 0 && (
            <p className="text-center text-muted-foreground py-8">
              {search ? 'No contacts match your search' : 'No contacts found'}
            </p>
          )}
        </div>
      </ScrollArea>

      {/* Import Button */}
      <Button
        onClick={handleImport}
        disabled={selectedIds.size === 0 || isImporting}
        className="w-full"
      >
        {isImporting
          ? 'Importing...'
          : `Import ${selectedIds.size} Contact${selectedIds.size !== 1 ? 's' : ''}`}
      </Button>
    </div>
  );
}
```

### Step 8: Create Import Page

Create `src/app/import/google/page.tsx`:

```typescript
'use client';

import { useState, useEffect } from 'react';
import { useSession } from 'next-auth/react';
import { useRouter } from 'next/navigation';
import { GoogleSignIn } from '@/components/google/GoogleSignIn';
import { ContactSelector } from '@/components/google/ContactSelector';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import { ParsedContact } from '@/lib/google/types';
import { Loader2, AlertCircle } from 'lucide-react';

export default function GoogleImportPage() {
  const { data: session, status } = useSession();
  const router = useRouter();
  const [contacts, setContacts] = useState<ParsedContact[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [progress, setProgress] = useState(0);

  useEffect(() => {
    if (session?.accessToken && contacts.length === 0) {
      fetchContacts();
    }
  }, [session]);

  const fetchContacts = async () => {
    setLoading(true);
    setError(null);

    try {
      const response = await fetch('/api/google/contacts');
      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Failed to fetch contacts');
      }

      setContacts(data.contacts);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'An error occurred');
    } finally {
      setLoading(false);
    }
  };

  const handleImport = (emails: string[]) => {
    // Store in session storage and redirect to bulk validation
    sessionStorage.setItem('importedEmails', JSON.stringify(emails));
    router.push('/bulk?source=google');
  };

  if (status === 'loading') {
    return (
      <div className="container mx-auto py-8 flex justify-center">
        <Loader2 className="h-8 w-8 animate-spin" />
      </div>
    );
  }

  return (
    <div className="container mx-auto py-8 max-w-3xl space-y-6">
      <div>
        <h1 className="text-3xl font-bold">Import from Google Contacts</h1>
        <p className="text-muted-foreground mt-2">
          Connect your Google account to import contacts for validation
        </p>
      </div>

      <GoogleSignIn />

      {session && (
        <Card>
          <CardHeader>
            <CardTitle>Your Contacts</CardTitle>
          </CardHeader>
          <CardContent>
            {loading && (
              <div className="space-y-4 py-8">
                <div className="flex justify-center">
                  <Loader2 className="h-8 w-8 animate-spin" />
                </div>
                <p className="text-center text-muted-foreground">
                  Loading contacts...
                </p>
                {progress > 0 && <Progress value={progress} />}
              </div>
            )}

            {error && (
              <div className="flex items-center gap-2 p-4 bg-destructive/10 rounded-lg text-destructive">
                <AlertCircle className="h-5 w-5" />
                <p>{error}</p>
              </div>
            )}

            {!loading && !error && contacts.length > 0 && (
              <ContactSelector
                contacts={contacts}
                onImport={handleImport}
              />
            )}

            {!loading && !error && contacts.length === 0 && (
              <p className="text-center text-muted-foreground py-8">
                No contacts with email addresses found
              </p>
            )}
          </CardContent>
        </Card>
      )}
    </div>
  );
}
```

### Step 9: Create Session Provider

Create `src/components/providers/SessionProvider.tsx`:

```typescript
'use client';

import { SessionProvider as NextAuthSessionProvider } from 'next-auth/react';
import { ReactNode } from 'react';

export function SessionProvider({ children }: { children: ReactNode }) {
  return <NextAuthSessionProvider>{children}</NextAuthSessionProvider>;
}
```

Update `src/app/layout.tsx`:

```typescript
import { SessionProvider } from '@/components/providers/SessionProvider';

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <body>
        <SessionProvider>
          {/* ... other providers */}
          {children}
        </SessionProvider>
      </body>
    </html>
  );
}
```

### Step 10: Write Tests

Create `src/__tests__/lib/google/contacts.test.ts`:

```typescript
import {
  filterContactsWithEmail,
  groupContactsByDomain,
} from '@/lib/google/contacts';
import { ParsedContact } from '@/lib/google/types';

describe('Google Contacts', () => {
  const mockContacts: ParsedContact[] = [
    { id: '1', name: 'John', email: 'john@gmail.com' },
    { id: '2', name: 'Jane', email: 'jane@yahoo.com' },
    { id: '3', name: 'Bob', email: 'bob@gmail.com' },
    { id: '4', name: 'Invalid', email: '' },
  ];

  describe('filterContactsWithEmail', () => {
    test('filters contacts with valid emails', () => {
      const result = filterContactsWithEmail(mockContacts);

      expect(result).toHaveLength(3);
      expect(result.every((c) => c.email.includes('@'))).toBe(true);
    });

    test('removes contacts without email', () => {
      const result = filterContactsWithEmail(mockContacts);

      expect(result.find((c) => c.name === 'Invalid')).toBeUndefined();
    });
  });

  describe('groupContactsByDomain', () => {
    test('groups contacts by email domain', () => {
      const filtered = filterContactsWithEmail(mockContacts);
      const groups = groupContactsByDomain(filtered);

      expect(groups.get('gmail.com')).toHaveLength(2);
      expect(groups.get('yahoo.com')).toHaveLength(1);
    });
  });
});
```

---

## Google Cloud Console Setup

### Required Steps:

1. **Create Project**
   - Go to [Google Cloud Console](https://console.cloud.google.com/)
   - Create a new project

2. **Enable People API**
   - Navigate to APIs & Services > Library
   - Search for "People API"
   - Click Enable

3. **Configure OAuth Consent Screen**
   - Go to APIs & Services > OAuth consent screen
   - Select External
   - Fill in app name, support email
   - Add scope: `https://www.googleapis.com/auth/contacts.readonly`

4. **Create OAuth Credentials**
   - Go to APIs & Services > Credentials
   - Create OAuth 2.0 Client ID
   - Application type: Web application
   - Add authorized redirect URIs:
     - `http://localhost:3000/api/auth/callback/google`
     - `https://yourdomain.com/api/auth/callback/google`

5. **Get Client ID and Secret**
   - Copy Client ID and Client Secret
   - Add to environment variables

---

## Completion Checklist

```
[ ] Dependencies installed
[ ] Environment variables documented
[ ] NextAuth configured
[ ] Google OAuth provider set up
[ ] TypeScript types defined
[ ] Contacts service created
[ ] API route for contacts
[ ] GoogleSignIn component
[ ] ContactSelector component
[ ] Import page created
[ ] SessionProvider configured
[ ] Privacy notice displayed
[ ] Error handling
[ ] Loading states
[ ] Search functionality
[ ] Select all/none feature
[ ] Import to bulk validation
[ ] Tests written and passing
[ ] Google Cloud setup documented
[ ] All existing tests pass
[ ] Changes committed and pushed
```

---

## Privacy Considerations

- Only request read-only access (`contacts.readonly`)
- Display clear privacy notice to users
- Don't store contact data on server
- Use session storage for temporary data
- Allow users to sign out and clear data

---

## Final Milestone

This is the final milestone. After completing this:

1. Run full test suite
2. Build and verify production build
3. Update main documentation
4. Create release notes
